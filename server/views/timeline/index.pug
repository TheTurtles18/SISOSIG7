extends ../layout

block append navigation
  br 
  br
  

block append content
  div(div='div' ng-app='main-app' ng-controller='postController')
    h2.page-header Stubble Feed
    hr
    li.nav-item#createPost
      form
        input#image-file(type='file' name='file' ng-model='thefile')
        //input#caption(type='text')
        button.btn.btn-primary(type='submit', value='submit', ng-click='submit()') Submit
    .row
      .card.col-md-3(ng-repeat='post in postArray')
        img.card-img-top(ng-src= 'api/images/' + '{{cardPic}}')
        .card-block
          h3.card-title {{post.caption}}
          h5 {{post.createdAt | date: 'medium'}}
          #likeDislike
            h6.card-shaves {{post.shave_votes}}
            a.btn.like(ng-click="updatePost(post._id, 'shave')") Shave
          #likeDislike
            h6.card-grows {{post.grow_votes}}
            a.btn.dislike(ng-click="updatePost(post._id, 'grow')") Grow
  
  // Javascript to Define Controller
  script.
      function getCookie(cname) {
    console.log("Function get cookie");
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) == ' ') {
        c = c.substring(1);
      }
      if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
      }
      }
    return "";
    }



    var app = angular.module("main-app", []);
    app.controller("postController", function($scope, $http, $log) {
      $scope.postArray = [];
      $scope.postLoader = function() {
        $http.get('/api/posts/').then(function(response) {
          $scope.postArray = response.data
          
        }).catch(function(err) {
          $log.debug(err);
        });
      } 
      $scope.postLoader();

    $scope.updatePost = function(id, type) {
      console.log(id + " " + type);
      $http({
        method: 'PUT',
        url: 'api/post/'+id+'?type='+type}).then(function(response) {
          console.log("then");
        $scope.dummy = response.data;
        $scope.postLoader();
      }).catch(function(err) {
        console.log("catch");
        $log.debug(err);
      });
    }

    

      

    $scope.submit = function() {
      var payload = new FormData();

      payload.append('file', $scope.thefile);
      console.log()
      $http({
        method: 'POST',
        url: 'api/upload', 
        data: payload,
        enctype: 'multipart/form-data', 
        transformRequest: angular.identity
        }).then(function(response) {
          console.log("then");
          console.log(response);
      }).catch(function(err) {
        console.log("catch");
        $log.debug(err);
      });
    }



    //- $scope.submit = function() {
    //-   $http({
    //-     method: 'POST',
    //-     url: '/api/upload'
    //-     enctype: 'multipart/form-data'
    //-   });
    //- }
    //enctype='multipart/form-data', action='/api/upload', method = "POST"
        
       $scope.cardPic = getCookie("mongoCookie");
      console.log("TEST");
      //$scope.cardPic = "http://placehold.it/200x150";
      
     
    

    });


